# Пакет навигации turtlebro_voice_nav для робота TurtleBro

## Описание пакета

Пакет **turtlebro_voice_nav** предназначен для управления роботом **TurtleBro** с использованием голосовых команд, которые задаются с помощью роботизированной головы **Bbrain 1.0**. Робот может перемещаться между точками, выполнять действия (например, "осмотрись") и взаимодействовать с пользователем через голосовой интерфейс.

Основные функции:
- **Перемещение робота** в указанные точки по голосовым командам.
- **Выполнение дополнительных действий**, таких как "осмотрись".
- **Озвучивание напоминаний** и озвучивание связанных с напоминанием фраз.
- **Возвращение в стартовую точку** после завершения команд.
- Интеграция с системой навигации ROS (**move_base**) и  (**turtlebro_navigation**).

---

## Установка пакета

### 1. Требования и зависимости
Для работы пакета необходимы следующие компоненты:
- **ROS Noetic** (пакет работает только на этой версии ROS).
- **Python 3.x**.
- Библиотека **toml** для работы с конфигурационными файлами.

Установите зависимости Python:
```bash
pip3 install toml
```

### 2. Клонирование пакета
Склонируйте репозиторий в рабочую директорию ROS:
```bash
cd ~/catkin_ws/src
git clone https://github.com/NikolayIvanovWS/turtlebro_voice_nav.git
cd ..
catkin_make --pkg=turtlebro_voice_nav
```

### 3. Настройка ROS-сети
Для корректной работы пакета необходимо настроить общую ROS-сеть между роботизированной головой **Bbrain** и роботом **TurtleBro**. Для этого необходимо на **роботизированной головой Bbrain** выполнить следующие действия:

1. Подключиться к роботизированной голове по SSH
```bash
ssh pi@<ip-адрес робоголовы>

Пароль по умолчанию: brobro
```
2. Остановить ubuntu-сервис `robohead.service`:
```bash
sudo systemctl stop robohead.service
```
3. Отредактировать файл `.bashrc`. Для этого необходимо:

   3.1. Открыть файл с помощью текстового редактора с правами суперпользователя:
   
   ```bash
   sudo nano ~/.bashrc
   ```

   3.2. Перейти в самый конец файла:
   
   ```bash
   # for work with another robot

   # ip of another robot:
   #export ROS_MASTER_URI=http://192.168.1.73:11311

   # ip of robohead:
   #export ROS_HOSTNAME=192.168.1.53

   # for local work (without a robot)
   export ROS_MASTER_URI=http://127.0.0.1:11311
   export ROS_HOSTNAME=127.0.0.1
   ```

   3.3. Закомментировать строчки с `export`, связанные с локальной работой робоголовы:
   
   ```bash
   # for local work (without a robot)
   #export ROS_MASTER_URI=http://127.0.0.1:11311
   #export ROS_HOSTNAME=127.0.0.1
   ```

   3.4. Раскомментировать строчки с `export`, связанные с работой с другим устройством. Выставить корректные IP-адреса робота TurtleBro и роботизированной головы:
   
   ```bash
   # for work with another robot
  
   # ip of another robot:
   export ROS_MASTER_URI=http://192.168.1.XX:11311
  
   # ip of robohead:
   export ROS_HOSTNAME=192.168.1.XX
   ```

   3.5. Сохранить файл и выйти из текстового редактора:
   
   ```bash
   CTRL+S
   CTRL+X
   ```

5. Отредактировать файл `start.sh`. Выполнить все те же самые действия как и с `.bashrc`

 ```bash
 sudo nano ~/start.sh
 ```

```bash
#!/bin/bash

source /opt/ros/noetic/setup.bash
source /home/pi/robohead_ws/devel/setup.bash

export PYTHONPATH=$PYTHONPATH:$ROS_ROOT/core/roslib/src
export PYTHONPATH=$PYTHONPATH:/usr/bin/python3
export PYTHONPATH=$PYTHONPATH:/home/pi/.local/lib/python3.8/site-packages

# for work with another robot

# ip of another robot:
export ROS_MASTER_URI=http://192.168.1.XX:11311

# ip of robohead:
export ROS_HOSTNAME=192.168.1.XX

# for local work (without a robot)
#export ROS_MASTER_URI=http://127.0.0.1:11311
#export ROS_HOSTNAME=127.0.0.1

roslaunch robohead_controller robohead_controller_py.launch
```
   
5. Синхронизировать данные на робоголове и перезагрузить её:

```bash
sudo sync

sudo reboot
```

6. **Обратите внимание, что с этого момента, робоголова будет полностью загружаться только в случае, если робот TurtleBro работает и находится в той же Wi-Fi сети, что и роботизированная голова**

После загрузки роботизированной головы проверьти список топиков. Там должны находиться топики связанные как с робоголовой, так и с роботом TurtleBro

Подробнее о настройке можно прочитать [здесь](ссылка)

---

## Конфигурация

### Файл конфигурации точек (`points.toml`)
Координаты точек задаются в файле конфигурации `points.toml`, который находится в папке `data/`. Пример содержимого файла:
```toml
[points]
стартоваяточка = { x = 0.0, y = 0.0, theta = 0.0 }
комнатуодин = { x = 1.0, y = 0.0, theta = 30.0 }
комнатудва = { x = 1.0, y = 1.0, theta = 10.0 }
комнатутри = { x = 0.0, y = 0.5, theta = 0.0 }
```
- Названия точек должны быть **единым словом**.
- Для корректной работы добавьте эти названия в фонетический словарь роботизированной головы.

### Файл конфигурации команд (`commands.toml`)
Файл `commands.toml` содержит ключевые фразы для команд голосовой навигации. Пример содержимого файла:
```toml
[movement_phrases]
phrases = ["езжай в", "переместись в", "иди в", "двигайся к"]
```
- Можно изменять или добавлять новые стартовые фразы.
- Для корректной работы добавьте эти фразы в фонетический словарь роботизированной головы.

### Файл конфигурации напоминаний (`speech.toml`)
Файл `speech.toml` содержит тексты напоминаний, которые робот может озвучивать. Пример содержимого файла:
```toml
[reminders]
выключитьробота = "Кожанные мешки. Не забудьте выключить робота. Перед уходом"
проверитьбатарею = "Убедитесь, что батарея заряжена"
закрытьдверь = "Не забудьте закрыть дверь"
анекдот = "Робот пошёл на свидание вслепую, но завис на этапе загрузки чувств."
```
- Можно изменять или добавлять новые напоминания.
- Для корректной работы добавьте эти команды в словарь фонетический роботизированной головы.

---

## Запуск пакета

### 1. Запуск пакета голосового управления
Запустите пакет `turtlebro_voice_nav`:
```bash
roslaunch turtlebro_voice_nav voice_nav.launch
```

### 2. Отправка голосовых команд
Используйте голосовой интерфейс для отправки команд. Например:
- Произнесите: `Слушай, робот!` <дождитесь перехода робоголовы в режим ожидания команды> `"езжай в комнатуодин"`.
- Робот переместится в указанную точку и будет ожидать следующую команду.

Поддерживаются следующие команды:
- **Перемещение в точку**: `<стартовая команда из commands.toml> <название точки из points.toml>`.
- **Команда "осмотрись"**: Робот поворачивается на определённые углы, передает изображение с камеры на роботизированную голову и возвращается в исходное положение.
- **Команда "напомни"**: Произнесите `"напомни <название напоминания из speech.toml>"`. Робот озвучит заданную фразу и вернется в стартовую точку.
- **Команда "сделай фото"**: Произнесите `"сделай фото"`. На роботизированное голове начнется обратный отсчет с изображением с камеры робота. После "фотографирования" робот вернется в стартовую точку.

- После каждой выполненой команды в точке робот будет возвращаться в **стартовую точку**.
---

## Тестирование

### 1. Эмуляция перемещений
Для тестирования без реального перемещения робота используйте флаг `fake_move_base`:
```bash
roslaunch turtlebro_voice_nav voice_nav.launch fake_move_base:=true
```

### 2. Логи
Проверяйте логи для отслеживания выполнения команд:
```bash
rostopic echo /rosout
```

---
